<!DOCTYPE html>
<html>

<head>
  <title>Virtual Hour Student Login</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
  <script src="https://www.gstatic.com/firebasejs/7.11.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.11.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.11.0/firebase-firestore.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyCwnSJODwjoQxsueGtoiIwAcNxo9Y6Zt78",
      authDomain: "virtual-hour.firebaseapp.com",
      databaseURL: "https://virtual-hour.firebaseio.com",
      projectId: "virtual-hour",
      storageBucket: "virtual-hour.appspot.com",
      messagingSenderId: "721474763020",
      appId: "1:721474763020:web:ea4e55f0bc329695d53129",
      measurementId: "G-TNVC2J28C0"
    };
    firebase.initializeApp(firebaseConfig);

    initApp = function() {
      firebase.auth().onAuthStateChanged(function(user) {
        if (user) {

        } else {
          location.href = 'auth.html';
        }
      }, function(error) {
        console.log(error);
      });
    };
    window.addEventListener('load', function() {
      initApp();
    });
  </script>

</head>

<style>
  table,
  td {
    border: 1px solid black;
  }
</style>

<body style="background-color:AliceBlue;">
  <div class="container-fluid">
    <div class="row" style="background-color:Navy;">
      <div class="col">
        <h1 align="center" style="color:white;">Virtual Hour</h1>
        <p align="center" style="color:white;"> <i>An Online Platform for Office Hours </i></p>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <br>
        <h3>Student Login For Virtual Hour</h3>
        <p style="color:red;" id="error"></p>
        <h5 id="class"></h5><br>
        <button style="width:150px; max-width:90vp" id="addToQueue" class="btn btn-info" onclick="addToQueue()">Join the Queue</button> <br><br>
        <button style="width:150px; max-width:90vp" id="seeQueue" class="btn btn-info" onclick="seeQueue()">See the Queue</button>
        <p style="color:red;" id="status"></p><br><br>
        <table id="queueTable"></table>
      </div>
    </div>

    <script>
      var classID = getParameterByName("givenID");
      if (classID && classID.trim()) {} else {
        document.getElementById("error").innerHTML = 'Invalid Class ID. <a href="index.html">Please try again.</a>';
        document.getElementById("addToQueue").disabled = true;
        document.getElementById("seeQueue").disabled = true;
      }

      function getParameterByName(name) {
        var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
        return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
      }

      function addToQueue() {
        document.getElementById("addToQueue").disabled = true;
        var db = firebase.firestore();

        if (!firebase.auth() || !firebase.auth().currentUser) {
          window.location.href = "index.html";
          return;
        }

        db.collection("classes").doc(classID).collection("students").doc(firebase.auth().currentUser.uid).set({
            creator: firebase.auth().currentUser.displayName,
            email: firebase.auth().currentUser.email,
            datetime: Date.now(),
            needHelp: ""
          })
          .then(function() {
            document.getElementById("error").innerHTML = "";
            document.getElementById("status").innerHTML = "You were added to the queue.";
            document.getElementById("class").innerHTML = "Welcome to class, " + classID;
            document.getElementById("addToQueue").disabled = false;
          })
          .catch(function(error) {
            document.getElementById("error").innerHTML = "";
            document.getElementById("class").innerHTML = "";
            document.getElementById("status").innerHTML =
              '<br><b>Join Queue: Error Occured. A Few of the Possible Reasons</b>:<br>1. Class ID is invalid. <a href="index.html">Try again</a> with a correct class ID.<br>2. You are not logged in with your school email. <a href="index.html">Go back to the home page</a> and try again.<br>3. It is quite likely that it was a one time error and just <a href="create.html">trying again</a> will resolve the issue.<br><br>Contact <a href="mailto:vshroff@sas.upenn.edu"> Vraj Shroff</a> if the problem persists.';
            document.getElementById("addToQueue").disabled = false;
          });
      }

      function seeQueue() {
        document.getElementById("seeQueue").disabled = true;

        var db = firebase.firestore();
        if (!firebase.auth() || !firebase.auth().currentUser) {
          window.location.href = "index.html";
          return;
        }
        db.collection("classes").doc(classID).collection("students").where("needHelp", "==", "")
          .get()
          .then(function(querySnapshot) {
            document.getElementById("seeQueue").disabled = false;

            document.getElementById("error").innerHTML = "";
            document.getElementById("status").innerHTML = "";
            document.getElementById("class").innerHTML = "Welcome to class, " + classID;
            var allStudents = [];
            querySnapshot.forEach(function(doc) {
              var temp = Object.values(doc.data());
              temp.splice(1, 1);
              temp.splice(1, 1);
              allStudents.push(temp);
            });
            createTable(allStudents, document.getElementById("queueTable"));
          })
          .catch(function(error) {
            document.getElementById("seeQueue").disabled = false;

            document.getElementById("error").innerHTML = "";
            document.getElementById("class").innerHTML = "";
            document.getElementById("status").innerHTML =
              '<br><b>See Queue: Error Occured. A Few of the Possible Reasons</b>:<br>1. Class ID is invalid. <a href="index.html">Try again</a> with a correct class ID.<br>2. You are not logged in with your school email. <a href="index.html">Go back to the home page</a> and try again.<br>3. It is quite likely that it was a one time error and just <a href="create.html">trying again</a> will resolve the issue.<br><br>Contact <a href="mailto:vshroff@sas.upenn.edu"> Vraj Shroff</a> if the problem persists.';
          });
      }

      function createTable(tableData, table) {
        table.innerHTML = "";
        var tableBody = document.createElement('tbody');

        tableData.forEach(function(rowData) {
          var row = document.createElement('tr');

          rowData.forEach(function(cellData) {
            var cell = document.createElement('td');
            cell.appendChild(document.createTextNode(cellData));
            row.appendChild(cell);
          });

          tableBody.appendChild(row);
        });

        table.appendChild(tableBody);
        document.body.appendChild(table);
      }
    </script>

  </div>
</body>


</html>